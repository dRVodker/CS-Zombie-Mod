#include "cszm_modules/lobbyambient"
#include "cszm_modules/newspawn"

array<array<CSpawnPoint@>> New_Spawns = 
{
	{
		CSpawnPoint(Vector(584.354, -224.996, -95.9688), QAngle(12.7412, -179.645, 0)),
		CSpawnPoint(Vector(439.966, -237.205, -95.9688), QAngle(-0.689773, 92.8354, 0)),
		CSpawnPoint(Vector(175.314, -215.657, -95.9688), QAngle(2.28683, 79.2955, 0)),
		CSpawnPoint(Vector(65.7508, -226.338, -95.9688), QAngle(4.64633, 7.6756, 0)),
		CSpawnPoint(Vector(605.611, -77.7375, -95.9688), QAngle(0.907439, 172.804, 0)),
		CSpawnPoint(Vector(608.658, 104.608, -95.9688), QAngle(3.48474, -159.499, 0)),
		CSpawnPoint(Vector(-91.8562, -227.162, -95.9688), QAngle(-1.27056, 173.639, 0)),
		CSpawnPoint(Vector(-201.05, -220.903, -95.9688), QAngle(2.10533, 105.432, 0)),
		CSpawnPoint(Vector(-525.365, -212.599, -95.9688), QAngle(1.52453, 31.8878, 0)),
		CSpawnPoint(Vector(-374.442, -221.22, -95.9688), QAngle(3.52103, 39.5471, 0)),
		CSpawnPoint(Vector(-774.642, -108.532, -95.9688), QAngle(17.0972, 136.504, 0)),
		CSpawnPoint(Vector(-733.182, 118.874, -95.9688), QAngle(9.0386, -160.588, 0)),
		CSpawnPoint(Vector(-566.305, -42.8651, -95.9688), QAngle(5.1545, -7.98265, 0)),
		CSpawnPoint(Vector(-507.148, 168.005, -95.9688), QAngle(0.653295, -56.9513, 0)),
		CSpawnPoint(Vector(-161.652, 141.324, -95.9688), QAngle(1.96009, 39.8971, 0)),
		CSpawnPoint(Vector(1.45467, 167.93, -95.9688), QAngle(3.99289, -55.3179, -0)),
		CSpawnPoint(Vector(47.424, -78.7952, -95.9688), QAngle(4.68259, 115.874, 0)),
		CSpawnPoint(Vector(-112.059, -72.9263, -95.9688), QAngle(2.28679, 117.193, 0)),
		CSpawnPoint(Vector(-390.633, 173.648, -95.9688), QAngle(6.86059, -96.5183, 0)),
		CSpawnPoint(Vector(224.958, 198.572, -95.9688), QAngle(7.87699, -84.5756, 0)),
		CSpawnPoint(Vector(398.236, 180.686, -95.9688), QAngle(6.35239, -115.104, 0)),
		CSpawnPoint(Vector(-185.982, 432.755, -95.9688), QAngle(7.65919, -115.322, 0)),
		CSpawnPoint(Vector(92.8285, 437.917, -95.9688), QAngle(3.59359, -48.8928, 0)),
		CSpawnPoint(Vector(-916.078, 360.936, -95.9688), QAngle(2.86759, -68.1317, 0)),
		CSpawnPoint(Vector(-650.045, 393.54, -95.9688), QAngle(2.06899, -74.3027, 0)),
		CSpawnPoint(Vector(-901.686, 176.619, -95.9688), QAngle(1.70598, 6.61001, 0)),
		CSpawnPoint(Vector(549.867, 413.586, -95.9688), QAngle(-0.181621, -147.266, 0)),
		CSpawnPoint(Vector(745.668, 316.549, -95.9688), QAngle(1.92377, -148.209, 0))
	},
	{
		CSpawnPoint(Vector(-800.851, 2851.32, -95.9688), QAngle(1.52448, -34.7356, 0)),
		CSpawnPoint(Vector(-769.841, 2624.35, -95.9688), QAngle(3.41207, -10.8501, 0)),
		CSpawnPoint(Vector(-644.988, 2702.35, -95.9688), QAngle(3.19428, 168.037, 0)),
		CSpawnPoint(Vector(-486.313, 2880.54, -95.9688), QAngle(-0.32683, -69.9103, 0)),
		CSpawnPoint(Vector(-400.531, 3029, -95.9688), QAngle(4.02918, -92.743, 0)),
		CSpawnPoint(Vector(-295.436, 2868.3, -95.9688), QAngle(2.39568, -116.011, 0)),
		CSpawnPoint(Vector(-495.698, 2718.45, -95.9688), QAngle(3.66618, -3.43279, 0)),
		CSpawnPoint(Vector(-295.231, 2719.56, -95.9688), QAngle(3.62989, -139.824, 0)),
		CSpawnPoint(Vector(-480.082, 2531.88, -95.9688), QAngle(5.80788, 105.698, 0)),
		CSpawnPoint(Vector(-340.177, 2577.78, -95.9688), QAngle(3.59358, 112.438, 0)),
		CSpawnPoint(Vector(-193.28, 2545.01, -95.9688), QAngle(-2.32331, 55.2287, 0)),
		CSpawnPoint(Vector(-107.669, 2615.08, -95.9688), QAngle(-10.636, 130.539, 0)),
		CSpawnPoint(Vector(59.1118, 2530.26, -95.9688), QAngle(9.51049, 44.4838, 0)),
		CSpawnPoint(Vector(58.9784, 2633.52, -95.9688), QAngle(-0.181606, 6.91327, 0)),
		CSpawnPoint(Vector(158.98, 2708.88, -95.9688), QAngle(1.66969, -4.73898, 0)),
		CSpawnPoint(Vector(-151.913, 2821.73, -95.9688), QAngle(-4.4287, 142.203, 0)),
		CSpawnPoint(Vector(23.4911, 2872.39, -95.9688), QAngle(7.18728, 34.3196, 0)),
		CSpawnPoint(Vector(-34.0856, 2829.58, -95.9688), QAngle(-7.33272, 103.339, 0)),
		CSpawnPoint(Vector(172.975, 2873.78, -95.9688), QAngle(10.418, -40.2278, 0)),
		CSpawnPoint(Vector(384.185, 2855.05, -95.9688), QAngle(6.38868, -115.514, 0)),
		CSpawnPoint(Vector(264.598, 3007.12, -95.9688), QAngle(1.27039, -77.2408, 0)),
		CSpawnPoint(Vector(424.027, 2585.49, -95.9688), QAngle(2.61349, 119.3, 0)),
		CSpawnPoint(Vector(275.568, 2586.53, -95.9688), QAngle(3.52099, 83.7262, 0)),
		CSpawnPoint(Vector(663.237, 2880.08, -95.9688), QAngle(3.77509, -161.53, 0)),
		CSpawnPoint(Vector(618.971, 2554.85, -95.9688), QAngle(3.12169, 148.921, -0)),
		CSpawnPoint(Vector(536.643, 2716.29, -95.9688), QAngle(3.30319, 31.8405, 0))
	},
	{
		CSpawnPoint(Vector(-240.262, 3255.7, -95.9688), QAngle(-5.08212, -55.0618, 0)),
		CSpawnPoint(Vector(682.34, 2541.17, -95.9688), QAngle(-1.85144, 158.322, 0)),
		CSpawnPoint(Vector(-816.198, 2830.26, -95.9688), QAngle(-0.87133, -47.7293, 0)),
		CSpawnPoint(Vector(-963.881, 2190.59, -95.9688), QAngle(-0.254221, -35.3146, 0)),
		CSpawnPoint(Vector(-192.407, 1658.08, -95.9688), QAngle(1.70598, 53.1847, 0)),
		CSpawnPoint(Vector(743.412, 1986.91, -95.9688), QAngle(2.28678, 176.388, 0)),
		CSpawnPoint(Vector(1534, 2443.74, -287.969), QAngle(-19.2028, -173.255, 0)),
		CSpawnPoint(Vector(1830.26, 1827.52, -7.34596), QAngle(11.0714, 179.631, 0)),
		CSpawnPoint(Vector(1759.47, 1212.89, 186.757), QAngle(-2.76654, 160.174, 0)),
		CSpawnPoint(Vector(1901.66, 720.031, -0.212097), QAngle(7.25229, 169.431, 0)),
		CSpawnPoint(Vector(332.282, 800.27, -95.9688), QAngle(1.1902, 177.707, 0)),
		CSpawnPoint(Vector(855.682, -72.6001, -95.9688), QAngle(2.7874, 161.88, 0)),
		CSpawnPoint(Vector(-533.542, -223.103, -95.9688), QAngle(0.210059, 37.3585, 0)),
		CSpawnPoint(Vector(-75.4081, 1305.55, -95.9688), QAngle(-2.33094, -38.1818, 0)),
		CSpawnPoint(Vector(-1228.48, 1532.46, -95.9688), QAngle(5.21945, -125.375, 0)),
		CSpawnPoint(Vector(-2424.53, 778.735, -37.5192), QAngle(7.10705, 17.3338, 0)),
		CSpawnPoint(Vector(-1610.12, 263.228, -95.9688), QAngle(7.76045, 48.2251, 0)),
		CSpawnPoint(Vector(1071.97, 1295.97, -222.969), QAngle(-11.5511, -162.4, 0)),
		CSpawnPoint(Vector(-581.644, 859.45, -95.9688), QAngle(0.210063, -160.404, 0)),
		CSpawnPoint(Vector(-1889.24, 2480.92, -95.9688), QAngle(-0.225535, -82.2239, 0)),
		CSpawnPoint(Vector(-1040.7, 3185.14, -95.9688), QAngle(10.6645, 123.295, 0)),
		CSpawnPoint(Vector(-1864.29, 3279.94, -87.9688), QAngle(0.899745, -16.1469, 0)),
		CSpawnPoint(Vector(827.57, 1472.23, -31.967), QAngle(3.87634, -19.0879, 0)),
		CSpawnPoint(Vector(-228.329, 470.758, -95.9688), QAngle(-0.370759, -58.0376, 0))
	}
};

const int TEAM_LOBBYGUYS = 0;
const int TEAM_SURVIVORS = 2;

int iMaxPlayers;

void OnMapInit()
{
	iMaxPlayers = Globals.GetMaxClients();

	Events::Player::OnPlayerSpawn.Hook(@OnPlayerSpawn);
}

void OnNewRound()
{	
	Engine.Ent_Fire("SND_Ambient", "StopSound");
	Engine.Ent_Fire("SND_Ambient", "PlaySound");
}

void OnMatchBegin() 
{
	Engine.Ent_Fire("SND_Ambient", "PlaySound");
}

void SetUpStuff()
{
	Engine.Ent_Fire("Precache", "kill");
	Engine.Ent_Fire("SND_Ambient", "PlaySound");
	
	Engine.Ent_Fire("shading", "StartOverlays");
	
	FlickerLight1();
	ChangeFog();
	PlayLobbyAmbient();
	
	RemoveNativeSpawns("info_player_zombie");
	RemoveNativeSpawns("info_player_human");
	CreateSpawnsFromArray(New_Spawns, true);
}

void OnProcessRound()
{

}

HookReturnCode OnPlayerSpawn(CZP_Player@ pPlayer)
{
	CBasePlayer@ pPlrEnt = pPlayer.opCast();
	CBaseEntity@ pBaseEnt = pPlrEnt.opCast();

	if (pBaseEnt.GetTeamNumber() == TEAM_LOBBYGUYS)
	{
		PlayLobbyAmbient();
	}

	return HOOK_CONTINUE;	
}

void ChangeFog()
{
	CBaseEntity@ pEntity = FindEntityByClassname(pEntity, "env_fog_controller");
	pEntity.SetEntityName("my_fog");
	Engine.Ent_Fire("my_fog", "SetStartDist", "-128");
	Engine.Ent_Fire("my_fog", "SetEndDist", "4096");
}

void FlickerLight1()
{
	float flInterval = Math::RandomFloat(0.085, 0.35);
	float flOffInterval = Math::RandomFloat(0.05, 0.20);
	Engine.Ent_Fire("FL-Prop1", "skin", "1");
	Engine.Ent_Fire("FL-Light1", "TurnOn");
	Engine.Ent_Fire("FL-Spr1", "ShowSprite");
	
	Schedule::Task(flOffInterval, "FlickerLight1Off");
	Schedule::Task(flInterval, "FlickerLight1");
}

void FlickerLight1Off()
{
	Engine.Ent_Fire("FL-Prop1", "skin", "0");
	Engine.Ent_Fire("FL-Light1", "TurnOff");
	Engine.Ent_Fire("FL-Spr1", "HideSprite");
}