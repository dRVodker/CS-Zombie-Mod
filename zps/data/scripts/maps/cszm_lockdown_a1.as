#include "cszm_modules/lobbyambient"
#include "cszm_modules/newspawn"

array<array<CSpawnPoint@>> LockDown_Spawns =
{
	{
		CSpawnPoint(Vector(-4138.46, 4427.45, 0.03125), QAngle(10.6716, 42.0047, -0)),
		CSpawnPoint(Vector(-4137.89, 4426.77, 0.03125), QAngle(1.77814, 39.754, 0)),
		CSpawnPoint(Vector(-4151.63, 4678.58, 0.03125), QAngle(0.507613, -61.0148, 0)),
		CSpawnPoint(Vector(-3808.63, 4525.52, 0.03125), QAngle(19.8192, -67.4398, 0)),
		CSpawnPoint(Vector(-4087.83, 4200.32, 0.03125), QAngle(0.979468, 43.9648, 0)),
		CSpawnPoint(Vector(-3667.46, 4105.66, 0.03125), QAngle(1.01578, 103.388, 0)),
		CSpawnPoint(Vector(-3399.12, 4203.44, 0.03125), QAngle(1.92328, 143.898, 0)),
		CSpawnPoint(Vector(-3593.6, 4627.66, 0.03125), QAngle(1.19727, 93.6954, 0)),
		CSpawnPoint(Vector(-3870.61, 4953.78, 64.0313), QAngle(23.2314, -10.3043, 0)),
		CSpawnPoint(Vector(-3668.6, 5077.55, 0.03125), QAngle(-3.19502, 38.4103, 0)),
		CSpawnPoint(Vector(-4049.39, 5372.5, 0.03125), QAngle(4.31906, 59.0651, 0)),
		CSpawnPoint(Vector(-3835.77, 6147.69, 0.03125), QAngle(0.68908, -99.8198, 0)),
		CSpawnPoint(Vector(-3522.66, 5632.35, 0.03125), QAngle(0.108292, -98.8032, 0)),
		CSpawnPoint(Vector(-3099.86, 5611.55, 0.03125), QAngle(0.471292, -66.0606, 0)),
		CSpawnPoint(Vector(-2781.72, 5177.34, 0.03125), QAngle(-0.0731959, 138.285, 0)),
		CSpawnPoint(Vector(-3125.79, 4958.2, 0.03125), QAngle(2.97601, -44.8255, 0)),
		CSpawnPoint(Vector(-2727.08, 4862.72, 0.03125), QAngle(-20.4375, -150.495, 0)),
		CSpawnPoint(Vector(-3415.07, 5011.39, 128.031), QAngle(0.362355, -74.0833, 0)),
		CSpawnPoint(Vector(-3347.04, 4495.15, 128.031), QAngle(2.39514, 21.5309, 0)),
		CSpawnPoint(Vector(-3099.01, 4757.98, 128.031), QAngle(3.95603, -119.386, 0)),
		CSpawnPoint(Vector(-3565.11, 4006.01, 128.031), QAngle(22.3964, 77.2149, 0)),
		CSpawnPoint(Vector(-2854.44, 4079.57, 128.031), QAngle(14.0111, 105.311, 0)),
		CSpawnPoint(Vector(-2696.39, 3296.03, 128.031), QAngle(-2.61427, 62.6818, 0)),
		CSpawnPoint(Vector(-2469.49, 3973.31, 128.031), QAngle(8.85652, 122.395, 0)),
		CSpawnPoint(Vector(-3647.25, 3435.77, 0.03125), QAngle(-2.25129, 16.4353, 0)),
		CSpawnPoint(Vector(-3045.41, 3585.16, 0.03125), QAngle(-0.545187, 111.977, -0))
	},
	{
		CSpawnPoint(Vector(-3879.11, 3210.04, 9.89143), QAngle(13.6844, -112.66, 0)),
		CSpawnPoint(Vector(-4117.35, 3104.47, -0.374029), QAngle(12.305, -45.3598, 0)),
		CSpawnPoint(Vector(-4023.79, 2603.67, 0.03125), QAngle(11.9783, 32.9393, 0)),
		CSpawnPoint(Vector(-3758.99, 2526.92, 0.03125), QAngle(9.40102, 119.333, 0)),
		CSpawnPoint(Vector(-3566.34, 2095.71, -1.28776), QAngle(12.5954, 103.361, 0)),
		CSpawnPoint(Vector(-3326.91, 2351.28, -1.99408), QAngle(-0.835587, 141.44, 0)),
		CSpawnPoint(Vector(-2951.95, 3187.42, 0.03125), QAngle(2.43142, -154.2, 0)),
		CSpawnPoint(Vector(-3027.84, 2549.77, -2.14899), QAngle(3.52042, 171.424, 0)),
		CSpawnPoint(Vector(-3432.03, 3113.48, -0.308811), QAngle(6.27923, 107.137, 0)),
		CSpawnPoint(Vector(-4121.55, 1385.49, 0.03125), QAngle(7.36823, 50.1331, 0)),
		CSpawnPoint(Vector(-3252.05, 1399.21, -4.63077), QAngle(4.21011, 118.631, 0)),
		CSpawnPoint(Vector(-3671.2, 1807.71, 0.03125), QAngle(7.11411, -19.7805, 0)),
		CSpawnPoint(Vector(-2885.79, 2018.13, -3.95109), QAngle(0.725327, -151.09, 0)),
		CSpawnPoint(Vector(-3159.52, 2171.03, -0.748093), QAngle(4.13752, -55.1491, 0)),
		CSpawnPoint(Vector(-2784.2, 1639.7, 128.031), QAngle(15.6446, 179.422, 0)),
		CSpawnPoint(Vector(-2779.69, 2284.49, 128.031), QAngle(9.03806, 136.261, 0)),
		CSpawnPoint(Vector(-2626.5, 3060.99, 128.031), QAngle(-1.38005, 144.283, 0)),
		CSpawnPoint(Vector(-2704, 3733.18, 128.031), QAngle(-8.49485, -48.9777, 0)),
		CSpawnPoint(Vector(-2726.7, 4229.85, 128.031), QAngle(6.09776, -37.0715, 0)),
		CSpawnPoint(Vector(-3410.36, 3483.55, 0.03125), QAngle(4.17386, -109.357, 0)),
		CSpawnPoint(Vector(-3607.06, 3492.89, 1.03125), QAngle(3.91976, -40.4963, 0)),
		CSpawnPoint(Vector(-2813.5, 3582.39, 128.031), QAngle(29.5476, -164.51, 0)),
		CSpawnPoint(Vector(-2879.74, 4007.58, 128.031), QAngle(18.7665, -97.8993, 0)),
		CSpawnPoint(Vector(-3367, 2647.56, -3.15575), QAngle(3.702, -131.477, 0))
	},
	{
		CSpawnPoint(Vector(-3212.54, 1400.23, -4.57603), QAngle(0.398672, 116.755, 0)),
		CSpawnPoint(Vector(-4073.07, 1817.66, 0.03125), QAngle(1.63287, -11.2982, 0)),
		CSpawnPoint(Vector(-3666.28, 2034.6, -1.26505), QAngle(-2.46902, 84.6427, 0)),
		CSpawnPoint(Vector(-2922.2, 3177.86, 0.03125), QAngle(-6.67983, -151.865, 0)),
		CSpawnPoint(Vector(-4098.5, 3125.29, 5.43501), QAngle(-2.43271, -32.9092, 0)),
		CSpawnPoint(Vector(-3671.39, 3434.45, 0.03125), QAngle(-0.182123, 15.9146, 0)),
		CSpawnPoint(Vector(-2812.25, 4076, 0.03125), QAngle(2.03218, -133.981, 0)),
		CSpawnPoint(Vector(-3130.67, 4980.72, 0.03125), QAngle(-1.12591, -55.9362, 0)),
		CSpawnPoint(Vector(-2563.22, 4218.2, 128.031), QAngle(4.50059, -70.77, 0)),
		CSpawnPoint(Vector(-2744, 1959.34, 128.031), QAngle(4.50058, 101.486, 0)),
		CSpawnPoint(Vector(-3299.56, 4549.95, 128.031), QAngle(6.27925, 10.07, 0)),
		CSpawnPoint(Vector(-4090.81, 4267.41, 128.031), QAngle(15.3906, -9.7738, 0)),
		CSpawnPoint(Vector(-4093.06, 4712.57, 0.03125), QAngle(5.91628, -57.1575, 0)),
		CSpawnPoint(Vector(-3591.66, 5178.51, 0.03125), QAngle(2.61297, -103.998, 0)),
		CSpawnPoint(Vector(-2787.63, 5679.97, 0.03125), QAngle(3.41157, -92.8166, 0)),
		CSpawnPoint(Vector(-3997.95, 6157.16, 0.03125), QAngle(1.37877, -62.639, 0)),
		CSpawnPoint(Vector(-3218.9, 3782.72, 0.03125), QAngle(3.41157, 40.9853, 0)),
		CSpawnPoint(Vector(-2728.61, 4784.43, 128.031), QAngle(17.8227, -117.597, 0)),
		CSpawnPoint(Vector(-3285.39, 4006.23, 128.031), QAngle(4.50057, 17.9838, 0)),
		CSpawnPoint(Vector(-3668.94, 4002.49, 0.03125), QAngle(2.79448, 95.7999, 0)),
		CSpawnPoint(Vector(-3112.52, 2766.13, -2.27394), QAngle(3.91978, 160.838, 0)),
		CSpawnPoint(Vector(-3406.26, 4267.92, 0.03125), QAngle(2.39519, 156.602, 0)),
		CSpawnPoint(Vector(-4030.8, 5353.76, 0.03125), QAngle(2.39518, 25.6322, 0)),
		CSpawnPoint(Vector(-2611.9, 3220.78, 128.031), QAngle(2.10477, -121.141, 0))
	},
	{
		CSpawnPoint(Vector(-3106.91, 4750.43, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3188.5, 4750.91, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3266.1, 4735.58, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3364.88, 4736.82, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3364.62, 4672.27, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3087.42, 4687.38, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3159.21, 4686.48, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3214.64, 4685.77, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3270.45, 4670.81, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3090.14, 4624.34, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3156.29, 4623.5, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3218.84, 4622.71, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3270, 4622.06, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3315.38, 4590.68, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3386.65, 4591.3, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3073.7, 4575.71, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3135.71, 4574.92, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3186.4, 4574.28, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3234.96, 4576.98, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3287.83, 4544.54, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3365.42, 4543.56, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3094.19, 4529.25, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3141.5, 4528.65, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3188.84, 4528.05, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3200.28, 4478.51, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3263.69, 4478.69, 128.031), QAngle(0, 0.725098, 0)),
		CSpawnPoint(Vector(-3347.63, 4480.66, 128.031), QAngle(0, 0.725098, 0))
	}
};

const int TEAM_LOBBYGUYS = 0;
int iMaxPlayers;

void OnMapInit()
{
	iMaxPlayers = Globals.GetMaxClients();

	Engine.PrecacheFile(sound, "buttons/lever8.wav");

	Entities::RegisterOutput("OnPressed", "fan_button");

	OnNewRound();
}

void OnNewRound()
{
	Schedule::Task(0.05f, "Stuff");
	Schedule::Task(0.05f, "LockDown_FindCrates");
}

void Stuff()
{
	RemoveNativeSpawns("info_player_human");
	RemoveNativeSpawns("info_player_zombie");
	CreateSpawnsFromArray(LockDown_Spawns);
	PlayLobbyAmbient();
	Shadows();

	Engine.Ent_Fire("what_a_light", "TurnOn");
	Engine.Ent_Fire("crates", "AddOutput", "physdamagescale 0.05");
	Engine.Ent_Fire("fan_button", "AddOutput", "wait 25");
}

void LockDown_FindCrates()
{
	CBaseEntity@ pEntity = null;

	while ((@pEntity = FindEntityByClassname(pEntity, "prop_itemcrate")) !is null)
	{
		pEntity.SUB_Remove();
	}
}

void OnEntityOutput(const string &in strOutput, CBaseEntity@ pActivator, CBaseEntity@ pCaller)
{
	string strTargetname = pCaller.GetEntityName();

	if (Utils.StrEql("OnPressed", strOutput) && Utils.StrEql("fan_button", strTargetname))
	{
		Engine.EmitSoundPosition(pCaller.entindex(), "buttons/lever8.wav", pCaller.GetAbsOrigin(), 0.85f, 65, 95);
		Engine.Ent_Fire("fan_switch", "SetAnimation", "switch");
		Engine.Ent_Fire("fan_switch", "SetPlaybackRate", "1.5");
		Engine.Ent_Fire("fan_switch", "SetPlaybackRate", "0", "0.85");
		Engine.Ent_Fire("fan_enable", "Trigger", "0", "1.5");
		Engine.Ent_Fire("fan_switch", "SetAnimation", "idle", "24.85");
	}
}

void Shadows()
{
	CBaseEntity@ pShadowControl = FindEntityByClassname(pShadowControl, "shadow_control");
	if (pShadowControl !is null)
	{
		Engine.Ent_Fire_Ent(pShadowControl, "SetShadowsDisabled", "0");
	}
}