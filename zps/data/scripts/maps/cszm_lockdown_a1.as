#include "cszm_modules/spawncrates"
#include "cszm_modules/lobbyambient"
#include "cszm_modules/newspawn"

array<array<CSpawnPoint@>> LockDown_Spawns =
{
	{
		CSpawnPoint(Vector(-2471.73, 4126.19, 128.031), QAngle(25.6278, -121.435, 0)),
		CSpawnPoint(Vector(-2763.2, 3092.31, 128.031), QAngle(2.90391, -51.6174, 0)),
		CSpawnPoint(Vector(-2765.12, 1588.18, 128.031), QAngle(12.3782, 130.077, 0)),
		CSpawnPoint(Vector(-3664.14, 1863.72, 0.03125), QAngle(0.798516, -36.8427, 0)),
		CSpawnPoint(Vector(-3879.64, 1456.25, 0.03125), QAngle(9.18379, 111.456, 0)),
		CSpawnPoint(Vector(-3126.8, 2262.25, -1.81313), QAngle(4.79144, 71.235, 0)),
		CSpawnPoint(Vector(-2881.7, 3191.5, 0.03125), QAngle(4.28324, -133.619, 0)),
		CSpawnPoint(Vector(-3912.55, 3164.73, 15.8928), QAngle(14.2294, -47.1894, 0)),
		CSpawnPoint(Vector(-3676.02, 3427.99, 0.03125), QAngle(1.95994, 18.8041, 0)),
		CSpawnPoint(Vector(-2695.17, 3849.22, 128.031), QAngle(13.2857, 50.3128, 0)),
		CSpawnPoint(Vector(-2763.2, 3092.31, 128.031), QAngle(2.90391, -51.6174, 0)),
		CSpawnPoint(Vector(-2765.12, 1588.18, 128.031), QAngle(12.3782, 130.077, 0)),
		CSpawnPoint(Vector(-3664.14, 1863.72, 0.03125), QAngle(0.798516, -36.8427, 0)),
		CSpawnPoint(Vector(-3879.64, 1456.25, 0.03125), QAngle(9.18379, 111.456, 0)),
		CSpawnPoint(Vector(-3643.13, 2022.72, -2.27134), QAngle(8.63929, 75.7725, 0)),
		CSpawnPoint(Vector(-3126.8, 2262.25, -1.81313), QAngle(4.79144, 71.235, 0)),
		CSpawnPoint(Vector(-2881.7, 3191.5, 0.03125), QAngle(4.28324, -133.619, 0)),
		CSpawnPoint(Vector(-3912.55, 3164.73, 15.8928), QAngle(14.2294, -47.1894, 0)),
		CSpawnPoint(Vector(-3676.02, 3427.99, 0.03125), QAngle(1.95994, 18.8041, 0)),
		CSpawnPoint(Vector(-3254.46, 3991.86, 128.031), QAngle(3.19407, 131.334, 0)),
		CSpawnPoint(Vector(-4159.97, 4337.43, 128.031), QAngle(3.66595, -18.7671, 0)),
		CSpawnPoint(Vector(-3333.5, 4492.15, 128.031), QAngle(4.64603, 33.033, 0)),
		CSpawnPoint(Vector(-3053.36, 4651.96, 128.031), QAngle(26.4986, -34.957, 0)),
		CSpawnPoint(Vector(-2811.54, 5041.15, 128.031), QAngle(16.625, -112.276, 0)),
		CSpawnPoint(Vector(-4138.02, 4435.66, 0.03125), QAngle(15.4633, 43.028, 0)),
		CSpawnPoint(Vector(-3799.61, 4528.19, 0.03125), QAngle(-2.39624, -62.3511, 0)),
		CSpawnPoint(Vector(-3856.05, 4951.17, 64.0313), QAngle(23.4131, -17.1709, 0)),
		CSpawnPoint(Vector(-3580.23, 5222.88, 0.03125), QAngle(4.31934, -110.316, 0)),
		CSpawnPoint(Vector(-4023.05, 5381.5, 0.03125), QAngle(2.86735, 44.4799, 0)),
		CSpawnPoint(Vector(-3989.78, 6137.8, 0.03125), QAngle(13.5758, -55.3087, 0)),
		CSpawnPoint(Vector(-3282.86, 5666.66, 0.03125), QAngle(2.25023, -158.945, 0)),
		CSpawnPoint(Vector(-2794.21, 5185.11, 0.03125), QAngle(2.86735, -115.457, 0)),

		CSpawnPoint(Vector(-3143.61, 4700.43, 0.03125), QAngle(7.72393, -35.4161, 0), "info_player_zombie"),
		CSpawnPoint(Vector(-3171.13, 4534.35, 0.03125), QAngle(1.51662, 26.9473, 0), "info_player_zombie"),
		CSpawnPoint(Vector(-3893.45, 5974.71, 0.03125), QAngle(8.59507, -90.8471, 0), "info_player_zombie"),
		CSpawnPoint(Vector(-3735.01, 1445.78, 0.03125), QAngle(2.02473, 41.0675, 0), "info_player_zombie")
	},
	{
		CSpawnPoint(Vector(-3612.69, 2206.06, -3.29223), QAngle(9.80061, 101.785, 0)),
		CSpawnPoint(Vector(-3395.86, 2308.33, -1.90202), QAngle(7.04182, 55.5023, 0)),
		CSpawnPoint(Vector(-3037.89, 3091.56, -2.4802), QAngle(8.05822, -130.802, 0)),
		CSpawnPoint(Vector(-3911.23, 3095.24, 12.824), QAngle(1.05235, -22.9184, 0)),
		CSpawnPoint(Vector(-4022.57, 1794.29, 0.03125), QAngle(4.8275, -11.8832, 0)),
		CSpawnPoint(Vector(-3270.12, 1495.34, 0.03125), QAngle(5.6624, 126.965, 0)),
		CSpawnPoint(Vector(-2891.38, 2063.95, 0.0287704), QAngle(5.2631, -135.122, 0)),
		CSpawnPoint(Vector(-2795.89, 2414.67, 128.031), QAngle(19.4564, 169.231, 0)),
		CSpawnPoint(Vector(-2655.52, 4210.78, 128.031), QAngle(10.9985, -33.5052, 0)),
		CSpawnPoint(Vector(-2894.23, 4135.15, 128.031), QAngle(15.2092, 112.325, 0)),
		CSpawnPoint(Vector(-2844.82, 3479.56, 0.03125), QAngle(7.40474, 157.01, 0)),
		CSpawnPoint(Vector(-3120.16, 5018.58, 0.03125), QAngle(5.66232, -67.7238, 0)),
		CSpawnPoint(Vector(-4104.62, 4275.35, 0.03125), QAngle(8.05812, 66.1634, 0)),
		CSpawnPoint(Vector(-3394.97, 4350, 128.031), QAngle(-5.69952, -145.877, 0)),
		CSpawnPoint(Vector(-3135.46, 4741.17, 128.031), QAngle(4.64604, -29.1597, 0)),
		CSpawnPoint(Vector(-3148.91, 4508.16, 128.031), QAngle(3.77483, 29.5737, 0)),
		CSpawnPoint(Vector(-3567.28, 4831.42, 128.031), QAngle(16.4072, 158.924, 0)),
		CSpawnPoint(Vector(-3566.09, 5470.76, 0.03125), QAngle(4.46442, -96.6047, 0)),
		CSpawnPoint(Vector(-4016.9, 5635.26, 0.03125), QAngle(0.652927, -28.7107, 0)),
		CSpawnPoint(Vector(-2730.35, 4575.71, 0.03125), QAngle(-19.5299, 170.069, 0)),
		CSpawnPoint(Vector(-3564.32, 4596.04, 0.03125), QAngle(4.90001, -119.655, 0)),
		CSpawnPoint(Vector(-3680.46, 3603.09, 0.03125), QAngle(-2.94081, -25.6023, 0)),
		CSpawnPoint(Vector(-3734.87, 1488.95, 0.03125), QAngle(8.85672, 44.6013, 0)),
		CSpawnPoint(Vector(-2627.82, 3116.25, 128.031), QAngle(9.25599, 116.984, 0)),

		CSpawnPoint(Vector(-3143.61, 4700.43, 0.03125), QAngle(7.72393, -35.4161, 0), "info_player_zombie"),
		CSpawnPoint(Vector(-3171.13, 4534.35, 0.03125), QAngle(1.51662, 26.9473, 0), "info_player_zombie"),
		CSpawnPoint(Vector(-3893.45, 5974.71, 0.03125), QAngle(8.59507, -90.8471, 0), "info_player_zombie"),
		CSpawnPoint(Vector(-3735.01, 1445.78, 0.03125), QAngle(2.02473, 41.0675, 0), "info_player_zombie")
	},
	{
		CSpawnPoint(Vector(-3400, 4732, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3326, 4732, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3242, 4732, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3178, 4732, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3114, 4732, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3400, 4668, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3326, 4668, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3242, 4668, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3178, 4668, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3114, 4668, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3400, 4604, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3326, 4604, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3242, 4604, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3178, 4604, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3114, 4604, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3400, 4540, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3326, 4540, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3242, 4540, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3178, 4540, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3114, 4540, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3400, 4476, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3326, 4476, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3242, 4476, 128), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-3178, 4476, 128), QAngle(0, 0, 0)),
		
		CSpawnPoint(Vector(-3143.61, 4700.43, 0.03125), QAngle(7.72393, -35.4161, 0), "info_player_zombie"),
		CSpawnPoint(Vector(-3171.13, 4534.35, 0.03125), QAngle(1.51662, 26.9473, 0), "info_player_zombie"),
		CSpawnPoint(Vector(-3893.45, 5974.71, 0.03125), QAngle(8.59507, -90.8471, 0), "info_player_zombie"),
		CSpawnPoint(Vector(-3735.01, 1445.78, 0.03125), QAngle(2.02473, 41.0675, 0), "info_player_zombie")
	}
};

const int TEAM_LOBBYGUYS = 0;
int iMaxPlayers;
bool bIsCratesFound = false;

void OnMapInit()
{
	iMaxPlayers = Globals.GetMaxClients();

	iMinCrates = 2;
	iMaxCrates = 4;
	flDistBetweenCrates = 407.0f;

	Engine.PrecacheFile(sound, "buttons/lever8.wav");

	Entities::RegisterOutput("OnPressed", "fan_button");

	OnNewRound();
}

void OnNewRound()
{
	Schedule::Task(0.05f, "Stuff");
	Schedule::Task(0.05f, "LockDown_FindCrates");
}

void OnProcessRound()
{

}

void OnMatchBegin() 
{
	Schedule::Task(0.5f, "SpawnCrates");
}

void Stuff()
{
	RemoveNativeSpawns("info_player_human");
	RemoveNativeSpawns("info_player_zombie");
	CreateSpawnsFromArray(LockDown_Spawns);
	PlayLobbyAmbient();
	Shadows();

	Engine.Ent_Fire("what_a_light", "TurnOn");
	Engine.Ent_Fire("crates", "AddOutput", "physdamagescale 0.05");
	Engine.Ent_Fire("fan_button", "AddOutput", "wait 25");
}

void LockDown_FindCrates()
{
	CBaseEntity@ pEntity = null;

	while ((@pEntity = FindEntityByClassname(pEntity, "prop_itemcrate")) !is null)
	{
		if (!bIsCratesFound)
		{
			g_PICOrigin.insertLast(pEntity.GetAbsOrigin());
			g_PICAngles.insertLast(pEntity.GetAbsAngles());		
		}
		pEntity.SUB_Remove();
	}

	if (!bIsCratesFound)
	{
		bIsCratesFound = true;
	}
}

void OnEntityOutput(const string &in strOutput, CBaseEntity@ pActivator, CBaseEntity@ pCaller)
{
	string strTargetname = pCaller.GetEntityName();

//	Chat.CenterMessage(all, "-=Output=-\nClass: " + pCaller.GetClassname() + "\nName: " + strTargetname);

	if (Utils.StrEql("OnPressed", strOutput) && Utils.StrEql("fan_button", strTargetname))
	{
		Engine.EmitSoundPosition(pCaller.entindex(), "buttons/lever8.wav", pCaller.GetAbsOrigin(), 0.85f, 65, 95);
		Engine.Ent_Fire("fan_switch", "SetAnimation", "switch");
		Engine.Ent_Fire("fan_switch", "SetPlaybackRate", "1.5");
		Engine.Ent_Fire("fan_switch", "SetPlaybackRate", "0", "0.85");
		Engine.Ent_Fire("fan_enable", "Trigger", "0", "1.5");
		Engine.Ent_Fire("fan_switch", "SetAnimation", "idle", "24.85");
	}
}

void Shadows()
{
	CBaseEntity@ pShadowControl = FindEntityByClassname(pShadowControl, "shadow_control");
	if (pShadowControl !is null)
	{
		Engine.Ent_Fire_Ent(pShadowControl, "SetShadowsDisabled", "0");
	}
}