#include "cszm_modules/lobbyambient"
#include "cszm_modules/newspawn"
#include "cszm_modules/cashmaker"

array<array<CSpawnPoint@>> LilaPanic_Spawns =
{
	{ 
		CSpawnPoint(Vector(-330.246, 377.472, -22.6158), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-272.485, 378.176, -18.7403), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-211.845, 378.914, -18.1478), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-151.206, 379.652, -23.1308), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-105.919, 380.204, -26.3264), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-51.0362, 380.872, -25.2065), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(9.16434, 381.605, -23.0846), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(61.7189, 382.245, -21.3292), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(113.723, 382.879, -21.8131), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(171.484, 383.582, -22.3692), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(223.489, 384.215, -24.2727), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(266.571, 384.74, -24.3965), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-333.628, 435.165, -11.493), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-276.99, 435.855, -24.3932), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-214.27, 436.619, -25.2473), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-144.998, 437.462, -23.0314), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-72.8662, 438.34, -21.0783), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(2.05284, 439.253, -22.765), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(59.9403, 439.957, -24.3295), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(126.262, 440.765, -27.3468), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(192.657, 441.573, -26.8625), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(150.979, 470.184, -23.0977), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(21.1407, 468.603, -17.2681), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-111.397, 466.989, -16.1479), QAngle(0, 90.6976, 0)),
		CSpawnPoint(Vector(-247.092, 465.337, -19.4329), QAngle(0, 90.6976, 0))
	},
	{
		CSpawnPoint(Vector(240.556, 299.03, 0.03125), QAngle(9.32908, 138.735, 0)),
		CSpawnPoint(Vector(109.895, 529.118, 0.03125), QAngle(6.53399, -151.46, 0)),
		CSpawnPoint(Vector(-285.345, 273.708, 0.03125), QAngle(-4.75533, 61.3076, 0)),
		CSpawnPoint(Vector(-430.892, 676.426, 0.03125), QAngle(0.61707, -137.339, 0)),
		CSpawnPoint(Vector(-786.204, 865.989, 0.03125), QAngle(0.181472, -57.007, 0)),
		CSpawnPoint(Vector(-846.011, 437.112, 0.03125), QAngle(2.94028, 30.1855, 0)),
		CSpawnPoint(Vector(-784.663, 50.5616, -10.7725), QAngle(1.96015, -19.0736, 0)),
		CSpawnPoint(Vector(-359.06, 164.799, -3.07509), QAngle(16.2261, -127.429, 0)),
		CSpawnPoint(Vector(-303.415, -218.909, 0.03125), QAngle(-11.253, -115.813, 0)),
		CSpawnPoint(Vector(-737.707, -606.494, 0.03125), QAngle(11.8701, 40.1319, 0)),
		CSpawnPoint(Vector(-524.513, -859.277, 0.03125), QAngle(11.5434, 95.5983, 0)),
		CSpawnPoint(Vector(-23.2161, -274.283, 0.03125), QAngle(4.17446, -127.115, 0)),
		CSpawnPoint(Vector(284.704, -283.378, 0.03125), QAngle(-16.9158, 38.9575, 0)),
		CSpawnPoint(Vector(419.749, -854.223, 0.03125), QAngle(6.96955, 65.3478, 0)),
		CSpawnPoint(Vector(805.445, -807.188, 0.03125), QAngle(5.77166, 135.806, 0)),
		CSpawnPoint(Vector(883.208, -333.756, 0.03125), QAngle(4.42856, -158.164, 0)),
		CSpawnPoint(Vector(550.344, -521.531, -43.7914), QAngle(-16.5891, 151.56, 0)),
		CSpawnPoint(Vector(697.013, 21.4249, -27.2728), QAngle(13.1406, 135.77, 0)),
		CSpawnPoint(Vector(852.138, 463.76, 0.03125), QAngle(7.00587, -153.808, 0)),
		CSpawnPoint(Vector(779.92, 850.971, 0.03125), QAngle(6.20732, -90.8277, 0)),
		CSpawnPoint(Vector(419.478, 874.107, 0.03125), QAngle(3.88413, -48.538, -0)),
		CSpawnPoint(Vector(-438.446, -532.541, -41.7016)),
		CSpawnPoint(Vector(83.6932, -700.094, 1.66466)),
		CSpawnPoint(Vector(-3.73331, -509.629, -29.574))
	},
	{
		CSpawnPoint(Vector(609.014, 968.173, -127.969), QAngle(-18.7671, -81.1953, 0)),
		CSpawnPoint(Vector(632.326, 1185.28, -127.969), QAngle(20.0013, -172.648, 0)),
		CSpawnPoint(Vector(837.411, 1333.2, -127.969), QAngle(5.95321, 163.842, 0)),
		CSpawnPoint(Vector(788.788, 1625.32, -127.969), QAngle(5.29981, -131.956, 0)),
		CSpawnPoint(Vector(456.294, 1628.52, -127.969), QAngle(-0.798588, -41.4235, 0)),
		CSpawnPoint(Vector(96.8639, 1709.9, -255.969), QAngle(-1.1616, -147.201, 0)),
		CSpawnPoint(Vector(249.807, 1272.74, -255.969), QAngle(0.399295, 109.46, 0)),
		CSpawnPoint(Vector(253.58, 1500.42, -255.969), QAngle(0.8712, -116.012, 0)),
		CSpawnPoint(Vector(82.2988, 1264.07, -255.969), QAngle(0.181498, 135.233, 0)),
		CSpawnPoint(Vector(417.203, 973.836, -255.969), QAngle(3.99298, -81.0913, 0)),
		CSpawnPoint(Vector(-408.912, 1162.2, -255.969), QAngle(-0.145217, -31.7348, 0)),
		CSpawnPoint(Vector(-258.495, 884.875, -255.969), QAngle(4.68268, 18.3109, 0)),
		CSpawnPoint(Vector(-350.499, 859.715, -255.969), QAngle(-0.181507, 140.538, 0)),
		CSpawnPoint(Vector(-854.135, 374.069, -255.969), QAngle(0.653409, 133.751, 0)),
		CSpawnPoint(Vector(-1369.42, 396.068, -119.969), QAngle(23.8854, 27.4639, 0)),
		CSpawnPoint(Vector(-1115.37, 806.664, -255.969), QAngle(2.46839, 13.4885, 0)),
		CSpawnPoint(Vector(-1121.82, 980.296, -255.969), QAngle(6.27989, -17.9472, 0)),
		CSpawnPoint(Vector(-911.416, 1255.99, -255.969), QAngle(0.689719, 28.9162, 0)),
		CSpawnPoint(Vector(-458.433, 1496.37, -255.969)),
		CSpawnPoint(Vector(-857.606, 1708.98, -255.969), QAngle(-0.435575, -11.3534, 0)),
		CSpawnPoint(Vector(-892.074, 1887.99, -255.969), QAngle(14.4111, -54.26, 0)),
		CSpawnPoint(Vector(-90.9465, 1453.46, -255.969), QAngle(5.51762, 125.685, 0)),
		CSpawnPoint(Vector(-319.969, 1491.8, -255.969), QAngle(3.41222, 50.2903, 0)),
		CSpawnPoint(Vector(510.373, 1402.48, -127.969), QAngle(3.77519, 49.0922, 0))
	}
};

enum Teams {TEAM_LOBBYGUYS, TEAM_SPECTATORS, TEAM_SURVIVORS}

int iMaxPlayers;

CBrushDoor@ pCDoor1;
CBrushDoor@ pCDoor2;

class CBrushDoor
{
	CBaseEntity@ pDoorEntity;
	CBaseEntity@ pButtonEntity;
	int iDoorIndex;
	bool bAllowUse;

	CBrushDoor(int EntIndex, CBaseEntity@ pDoor, CBaseEntity@ pButton)
	{
		@pDoorEntity = pDoor;
		@pButtonEntity = pButton;
		iDoorIndex = EntIndex;
		bAllowUse = true;
	}

	void Toggle()
	{
		if (bAllowUse)
		{
			bAllowUse = false;
			Engine.Ent_Fire_Ent(pDoorEntity, "Toggle");
		}
	}

	void UpdateButton()
	{
		pButtonEntity.SetAbsAngles(pDoorEntity.GetAbsAngles());
		bAllowUse = true;
	}

	void Remove(int EntIndex)
	{
		if (EntIndex == iDoorIndex)
		{
			pButtonEntity.SUB_Remove();
			this is null;
		}
	}
}

void CashDATA()
{
	MaxRandomCash = 27;
	MinRandomCash = 15;

	InsertToArray(-4.58305, 742.143, 304.595);
	InsertToArray(-110.399, 897.988, 273.031);
	InsertToArray(274.831, 805.971, 169.031);
	InsertToArray(250.886, 714.121, 173.031);
	InsertToArray(-261.416, 612.668, 137.031);
	InsertToArray(362.992, 650.264, 1.03125);
	InsertToArray(-865.48, 248.085, 55.3741);
	InsertToArray(-901.819, 611.206, 137.031);
	InsertToArray(338.413, 630.164, 425.433);
	InsertToArray(-174.823, 109.467, 537.031);
	InsertToArray(736.779, -869.303, 429.304);
	InsertToArray(863.411, 235.614, 122.082);
	InsertToArray(236.318, 221.235, 357.679);
	InsertToArray(179.209, -240.623, 157.19);
	InsertToArray(-0.691135, -232.871, 216.602);
	InsertToArray(-141.748, 227.959, 168.467);
	InsertToArray(-29.3542, 230.695, 142.691);
	InsertToArray(-219.247, -13.4412, 33.0313);
	InsertToArray(240.878, -151.885, 69.2032);
	InsertToArray(-60.5293, 240.814, 5.90483);
	InsertToArray(-899.457, -717.978, 43.0313);
	InsertToArray(454.025, 1262.15, -94.9688);
	InsertToArray(875.436, 1700.42, -121.824);
	InsertToArray(874.176, 1271.58, -121.824);
	InsertToArray(863.308, 1564.45, -84.9688);
	InsertToArray(-26.8838, 1436.85, -213.969);
	InsertToArray(-795.078, 1931.48, -170.272);
	InsertToArray(-930.02, 1569.44, -230.717);
	InsertToArray(-599.967, 1480.12, -254.969);
	InsertToArray(-1140.89, 647.903, -170.841);
	InsertToArray(-633.085, 982.999, -197.771);
	InsertToArray(-263.265, 817.959, -200.816);
	InsertToArray(353.604, 863.145, -234.81);
	InsertToArray(-191.621, -170.54, 411.031);
	InsertToArray(212.584, 154.991, 411.031);
	InsertToArray(589.627, -894.869, 1.03125);
}

void OnMapInit()
{
	iMaxPlayers = Globals.GetMaxClients();

	Events::Player::OnPlayerSpawn.Hook(@OnPlayerSpawn);
	Events::Trigger::OnStartTouch.Hook(@OnStartTouch);
	Events::Entities::OnEntityDestruction.Hook(@OnEntityDestruction);

	Entities::RegisterUse("func_button");

	Entities::RegisterOutput("OnFullyClosed", "func_door_rotating");
	Entities::RegisterOutput("OnFullyOpen", "func_door_rotating");

	Engine.Ent_Fire("breencrate", "FireUser1", "", "0.01");
	CashDATA();
	OnNewRound();
}

void OnNewRound()
{
	Schedule::Task(0.05f, "SetUpStuff");
}

HookReturnCode OnPlayerSpawn(CZP_Player@ pPlayer)
{
	CBasePlayer@ pPlrEnt = pPlayer.opCast();
	CBaseEntity@ pBaseEnt = pPlrEnt.opCast();

	int iIndex = pBaseEnt.entindex();
	int iTeamNum = pBaseEnt.GetTeamNumber();

	if (iTeamNum != TEAM_LOBBYGUYS)
	{
		Engine.Ent_Fire_Ent(pBaseEnt, "SetFogController", "main_insta_fog");
	}
	else
	{
		PlayLobbyAmbient();
	}

	return HOOK_CONTINUE;
}

HookReturnCode OnStartTouch(CBaseEntity@ pTrigger, const string &in strEntityName, CBaseEntity@ pEntity)
{
	if (pEntity.GetTeamNumber() == TEAM_LOBBYGUYS && pEntity.IsPlayer() && Utils.StrEql(strEntityName, "fog_volume_lobby"))
	{
		Engine.Ent_Fire_Ent(pEntity, "SetFogController", "lobby_fog");
	}

	return HOOK_HANDLED;
}

HookReturnCode OnEntityDestruction(const string &in strClassname, CBaseEntity@ pEntity)
{
	if (Utils.StrEql(strClassname, "func_door_rotating"))
	{
		pCDoor1.Remove(pEntity.entindex());
		pCDoor2.Remove(pEntity.entindex());
	}

	return HOOK_CONTINUE;
}

void OnEntityUsed(CZP_Player@ pPlayer, CBaseEntity@ pEntity)
{
	if (pEntity is null || pPlayer is null) 
	{
		return;
	}

	CBasePlayer@ pPlrEnt = pPlayer.opCast();
	CBaseEntity@ pBaseEnt = pPlrEnt.opCast();

	int iIndex = pBaseEnt.entindex();
	int iTeamNum = pBaseEnt.GetTeamNumber();

	if (iTeamNum == TEAM_SURVIVORS)
	{
		if (Utils.StrEql(pEntity.GetEntityName(), "CBD_Button1"))
		{
			pCDoor1.Toggle();
		}
		else if (Utils.StrEql(pEntity.GetEntityName(), "CBD_Button2"))
		{
			pCDoor2.Toggle();
		} 
	}
}

void OnEntityOutput(const string &in strOutput, CBaseEntity@ pActivator, CBaseEntity@ pCaller)
{
	if (pActivator is null || pCaller is null)
	{
		 return;
	}

	if (Utils.StrEql(pCaller.GetEntityName(), "ContainerBDoor1"))
	{
		pCDoor1.UpdateButton();
	}
	else if (Utils.StrEql(pCaller.GetEntityName(), "ContainerBDoor2"))
	{
		pCDoor2.UpdateButton();
	}
}

void OnMatchBegin() 
{
	FindCDoors();
}

void SetUpStuff()
{
	VMSkins();
	RandomizePropCrate();
	PlayLobbyAmbient();

	RemoveNativeSpawns("info_player_human");
	RemoveNativeSpawns("info_player_zombie");
	CreateSpawnsFromArray(LilaPanic_Spawns, true);
}

void VMSkins()
{
	for (int i = 1; i <= 10; i++)
	{
		Engine.Ent_Fire("vm"+i, "Skin", ""+Math::RandomInt(0, 2));
	}
}

void RandomizePropCrate()
{
	CBaseEntity@ pEntity;
	while ((@pEntity = FindEntityByClassname(pEntity, "prop_itemcrate")) !is null)
	{
		if (Utils.StrEql("breencrate", pEntity.GetEntityName()))
		{
			Engine.Ent_Fire_Ent(pEntity, "AddOutput", "ItemCount 0");
			Engine.Ent_Fire_Ent(pEntity, "AddOutput", "ItemClass item_ammo_pistol");
			continue;
		}

		pEntity.SUB_Remove();
	}
}

void FindCDoors()
{
	pCDoor1 is null;
	pCDoor2 is null;

	CBaseEntity@ pDoor;
	CBaseEntity@ pButton;

	@pDoor = FindEntityByName(null, "ContainerBDoor1");
	@pButton = FindEntityByName(null, "CBD_Button1");

	if (pDoor !is null && pButton !is null)
	{
		@pCDoor1 = CBrushDoor(pDoor.entindex(), pDoor, pButton);
	}

	@pDoor = FindEntityByName(null, "ContainerBDoor2");
	@pButton = FindEntityByName(null, "CBD_Button2");

	if (pDoor !is null && pButton !is null)
	{
		@pCDoor2 = CBrushDoor(pDoor.entindex(), pDoor, pButton);
	}
}