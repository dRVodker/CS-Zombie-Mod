#include "cszm_modules/lobbyambient"
#include "cszm_modules/newspawn"
#include "cszm_modules/cashmaker"

array<array<CSpawnPoint@>> New_Spawns = 
{
	{
		CSpawnPoint(Vector(907.069, -1158.95, -143.969), QAngle(0, -170.26, 0)),
		CSpawnPoint(Vector(902.541, -1304.11, -143.969), QAngle(0.1815, 166.15, 0)),
		CSpawnPoint(Vector(767.353, -1291.4, -143.969), QAngle(0, 148.866, 0)),
		CSpawnPoint(Vector(698.493, -1205.65, -143.969), QAngle(0, -174.944, 0)),
		CSpawnPoint(Vector(613.716, -1300.02, -143.969), QAngle(0.1089, 149.812, 0)),
		CSpawnPoint(Vector(549.914, -1174.2, -143.969), QAngle(0.1815, -157.991, 0)),
		CSpawnPoint(Vector(487.374, -1299.75, -143.969), QAngle(0, 178.017, 0)),
		CSpawnPoint(Vector(373.205, -1271.23, -143.969), QAngle(0, -169.175, 0)),
		CSpawnPoint(Vector(256.655, -1315.95, -143.969), QAngle(0, 161.569, 0)),
		CSpawnPoint(Vector(167.273, -1170.54, -143.969), QAngle(0.0726, -136.798, 0)),
		CSpawnPoint(Vector(-842.68, 27.8867, -191.969), QAngle(0, -28.9339, 0)),
		CSpawnPoint(Vector(-812.34, -83.3114, -191.969), QAngle(0, -3.04536, 0)),
		CSpawnPoint(Vector(-762.45, -172.683, -191.969), QAngle(0, -24.1698, 0)),
		CSpawnPoint(Vector(-737.996, -34.1848, -191.969), QAngle(0, -22.4584, 0)),
		CSpawnPoint(Vector(-646.135, -183.45, -191.969), QAngle(0, -36.1048, 0)),
		CSpawnPoint(Vector(-650.586, -18.7945, -191.969), QAngle(0, -43.83, 0)),
		CSpawnPoint(Vector(-558.896, -105.291, -191.969), QAngle(0.0363, -11.7044, 0)),
		CSpawnPoint(Vector(-568.143, -303.677, -191.969), QAngle(0, 32.513, 0)),
		CSpawnPoint(Vector(-536.902, -205.654, -191.969), QAngle(0.1452, -24.2283, 0)),
		CSpawnPoint(Vector(-625.858, -249.056, -191.969), QAngle(0, 8.69993, 0)),
		CSpawnPoint(Vector(-231.278, -1001.27, -143.969), QAngle(0, -175.963, 0)),
		CSpawnPoint(Vector(-237.053, -919.458, -143.969), QAngle(0, -175.963, 0)),
		CSpawnPoint(Vector(-243.861, -822.996, -143.969), QAngle(0, -175.963, 0)),
		CSpawnPoint(Vector(-399.824, -992.532, -143.969), QAngle(0.0726, 37.0063, 0)),
		CSpawnPoint(Vector(226.393, 100.908, -143.969), QAngle(0.1452, -135.072, 0))
	},
	{
		CSpawnPoint(Vector(-260.33, -562.995, -143.969)), 
		CSpawnPoint(Vector(-162.768, -542.458, -143.969)),
		CSpawnPoint(Vector(-92.6469, -591.64, -143.969)), 
		CSpawnPoint(Vector(8.41257, -579.925, -143.969)), 
		CSpawnPoint(Vector(-84.0908, -501.808, -143.969)),
		CSpawnPoint(Vector(-142.569, -424.55, -143.969)), 
		CSpawnPoint(Vector(-250.47, -456.703, -143.969)), 
		CSpawnPoint(Vector(-4.0595, -465.13, -143.969)),
		CSpawnPoint(Vector(-286.332, -390.288, -143.969)),
		CSpawnPoint(Vector(-171.014, -323.457, -143.969)),
		CSpawnPoint(Vector(-28.8815, -332.674, -143.969)),
		CSpawnPoint(Vector(-61.0384, -402.101, -143.969)),
		CSpawnPoint(Vector(-29.6997, -205.769, -143.969)),
		CSpawnPoint(Vector(-170.698, -228.529, -143.969)),
		CSpawnPoint(Vector(-265.845, -274.57, -143.969)), 
		CSpawnPoint(Vector(-241.153, -178.307, -143.969)),
		CSpawnPoint(Vector(-146.514, -151.006, -143.969)),
		CSpawnPoint(Vector(-97.8256, -290.105, -143.969)),
		CSpawnPoint(Vector(64.0009, -265, -143.969)),
		CSpawnPoint(Vector(33.8773, -116.878, -143.969)), 
		CSpawnPoint(Vector(-53.7206, -93.3592, -143.969)),
		CSpawnPoint(Vector(-200.888, -84.5608, -143.969)),
		CSpawnPoint(Vector(-308.86, -75.1568, -143.969)), 
		CSpawnPoint(Vector(221.121, -353.105, -143.969)), 
		CSpawnPoint(Vector(230.735, -92.9227, -143.969)), 
		CSpawnPoint(Vector(19.2015, 82.2281, -143.969)),
		CSpawnPoint(Vector(-211.617, 66.8983, -143.969)),
		CSpawnPoint(Vector(204.528, 70.9945, -143.969))
	},
	{
		CSpawnPoint(Vector(13.4294, -591.303, -143.969), QAngle(1.92377, 125.674, 0)),
		CSpawnPoint(Vector(-249.788, -505.83, -143.969), QAngle(0.217654, 66.2141, 0)),
		CSpawnPoint(Vector(-156.527, 57.0538, -143.969), QAngle(4.06545, -68.2047, 0)),
		CSpawnPoint(Vector(185.578, -106.557, -143.969), QAngle(1.23405, -156.378, -0)),
		CSpawnPoint(Vector(-774.829, -34.2208, -191.969), QAngle(1.85116, -43.5211, 0)),
		CSpawnPoint(Vector(-533.725, -983.845, -143.969), QAngle(3.52096, 25.2312, 0)),
		CSpawnPoint(Vector(-151.788, -734.38, -143.969), QAngle(1.99636, -146.445, 0)),
		CSpawnPoint(Vector(27.0907, -1238.88, -143.969), QAngle(1.70596, 127.766, 0)),
		CSpawnPoint(Vector(883.793, -1166.5, -143.969), QAngle(1.56076, -150.922, 0)),
		CSpawnPoint(Vector(707.004, -707.963, -143.969), QAngle(6.78791, -137.273, 0)),
		CSpawnPoint(Vector(171.298, -858.78, -143.969), QAngle(5.0455, 37.8507, 0)),
		CSpawnPoint(Vector(-77.4337, -7.16623, -303.969), QAngle(5.11807, -104.834, 0)),
		CSpawnPoint(Vector(566.494, -526.992, -447.969), QAngle(17.4964, -109.068, 0)),
		CSpawnPoint(Vector(1193.87, -538.038, -447.969), QAngle(8.16736, 155.196, 0)),
		CSpawnPoint(Vector(1071.04, -971.843, -447.969), QAngle(15.8267, 179.88, 0)),
		CSpawnPoint(Vector(177.671, -1124.83, -543.969), QAngle(3.84764, 51.9226, 0)),
		CSpawnPoint(Vector(348.052, -738.362, -543.969), QAngle(5.91673, -29.4136, 0)),
		CSpawnPoint(Vector(183.597, -854.75, 0.03125), QAngle(3.92022, 32.466, 0)),
		CSpawnPoint(Vector(-375.066, -433.984, 0.03125), QAngle(12.9952, 38.746, 0)),
		CSpawnPoint(Vector(656.781, -1278.78, 48.0313), QAngle(1.74223, 142.068, 0)),
		CSpawnPoint(Vector(-450.728, -873.861, 48.0313), QAngle(18.7306, -51.8592, 0)),
		CSpawnPoint(Vector(-705.187, 80.3288, 64.0313), QAngle(2.79493, -0.953661, 0)),
		CSpawnPoint(Vector(164.025, -159.807, 0.03125), QAngle(24.2482, -161.073, 0)),
		CSpawnPoint(Vector(-121.013, -1189.39, 48.0313), QAngle(24.2845, 109.061, 0))
	}
};

const int TEAM_LOBBYGUYS = 0;

float flFan1FLTime = 0.0f;
float flFan2FLTime = 0.0f;

int iF1SPitch = 0;
bool bFan1IsOn = false;
float flFan1Delay = 0.0f;

int iF2SPitch = 0;
bool bFan2IsOn = false;
float flFan2Delay = 0.0f;

void SD(const string &in strMSG)
{
	Chat.PrintToChat(all, strMSG);
}

void OnMapInit()
{
	Schedule::Task(0.05f, "SetUpStuff");

	Entities::RegisterUse("func_button");
	Events::Trigger::OnStartTouch.Hook(@OnStartTouch);
	Events::Player::OnPlayerSpawn.Hook(@OnPlayerSpawn);

	CashData();
}

void OnNewRound()
{	
	bFan1IsOn = false;
	bFan2IsOn = false;
	iF1SPitch = 0;
	iF2SPitch = 0;
	Schedule::Task(0.05f, "SetUpStuff");
}

void OnProcessRound()
{
	if (flFan1FLTime <= Globals.GetCurrentTime() && bFan1IsOn)
	{
		flFan1FLTime = Globals.GetCurrentTime() + 1.1f;
		Engine.Ent_Fire("snd_fan1", "Volume", "10");
	}

	if (flFan2FLTime <= Globals.GetCurrentTime() && bFan2IsOn)
	{
		flFan2FLTime = Globals.GetCurrentTime() + 1.1f;
		Engine.Ent_Fire("snd_fan2", "Volume", "10");
	}
}

void SetUpStuff()
{
	Engine.Ent_Fire("screenoverlay", "StartOverlays");
	Engine.Ent_Fire("Precache", "Kill");
	Engine.Ent_Fire("vrad*", "Kill");
	
	Engine.Ent_Fire("tonemap", "SetBloomScale", "0.375");

	Engine.Ent_Fire("hurt_toxic*", "addoutput", "spawnflags 1088", "0.05");

	TurnOnFan1();

	PlayLobbyAmbient();

	RemoveNativeSpawns("info_player_zombie");
	RemoveNativeSpawns("info_player_human");
	CreateSpawnsFromArray(New_Spawns, true);
}

void CashData()
{
	iMaxCash = 12;
	iMinCash = 8;
	flMaxMPI = 175.0f;
	flMinMPI = 45.0f;

	g_Origins.insertLast(Vector(-356.433, -1429.81, 154.526));
	g_Origins.insertLast(Vector(-355.539, -1410.98, 154.526));
	g_Origins.insertLast(Vector(403.124, -914.462, 161.031));
	g_Origins.insertLast(Vector(394.451, -769.401, 145.031));
	g_Origins.insertLast(Vector(910.001, -408.19, 422.79));
	g_Origins.insertLast(Vector(920.474, -390.295, 422.763));
	g_Origins.insertLast(Vector(909.233, -382.09, 422.725));
	g_Origins.insertLast(Vector(1233.67, -362.098, -359.874));
	g_Origins.insertLast(Vector(410.493, -377.005, -542.969));
	g_Origins.insertLast(Vector(432.5, -1206.51, -302.969));
	g_Origins.insertLast(Vector(417.573, -1218.17, -302.969));
	g_Origins.insertLast(Vector(367.772, -1176.92, -302.969));
	g_Origins.insertLast(Vector(-339.996, -381.77, -230.074));
	g_Origins.insertLast(Vector(-518.024, 89.659, -142.969));
	g_Origins.insertLast(Vector(-122.988, -820.316, -142.969));
	g_Origins.insertLast(Vector(-289.004, -719.739, -109.054));
	g_Origins.insertLast(Vector(-312.326, -724.114, -109.032));
	g_Origins.insertLast(Vector(79.2919, -451.216, 1.03125));
	g_Origins.insertLast(Vector(71.0485, -429.527, 1.03125));
	g_Origins.insertLast(Vector(62.9824, -446.235, 1.03125));
	g_Origins.insertLast(Vector(-529.314, -354.646, 81.0313));
	g_Origins.insertLast(Vector(-536.301, -341.571, 81.0313));
}

HookReturnCode OnPlayerSpawn(CZP_Player@ pPlayer)
{
	CBasePlayer@ pPlrEnt = pPlayer.opCast();
	CBaseEntity@ pBaseEnt = pPlrEnt.opCast();

	if (pBaseEnt.GetTeamNumber() == TEAM_LOBBYGUYS)
	{
		PlayLobbyAmbient();
	}

	return HOOK_CONTINUE;	
}

HookReturnCode OnStartTouch(CBaseEntity@ pTrigger, const string &in strEntityName, CBaseEntity@ pEntity)
{
	if (strEntityName == "hurt_toxic1" || strEntityName == "hurt_toxic2")
	{
		if (!pEntity.IsPlayer())
		{
			if (Utils.StrContains("weapon_", pEntity.GetClassname()) || Utils.StrContains("item_", pEntity.GetClassname()))
			{
				pEntity.SUB_Remove();
			}
		}
	}

	return HOOK_CONTINUE;
}

void OnEntityUsed(CZP_Player@ pPlayer, CBaseEntity@ pEntity)
{
	if (pEntity.GetEntityName() == "button_fan1")
	{
		if (flFan1Delay <= Globals.GetCurrentTime())
		{
			if (iF1SPitch == 100 || iF1SPitch == 0)
			{
				Engine.EmitSoundEntity(pEntity, "Buttons.snd14");
				flFan1Delay = Globals.GetCurrentTime() + 20.0f;

				if (bFan1IsOn)
				{
					bFan1IsOn = false;
					iF1SPitch = 100;
					Fan1SNDStop();
					Engine.Ent_Fire("func_fan1", "stop");
					Engine.Ent_Fire("fanpush", "disable", "0", "0.75");
					Schedule::Task(10.0f, "TurnOnFan1");
				}

				else
				{
					bFan1IsOn = true;
					iF1SPitch = 0;
					Fan1SNDPlay();
					Engine.Ent_Fire("func_fan1", "start");
					Engine.Ent_Fire("fanpush", "enable", "0", "1.25");
				}
			}
		}
	}

	if (pEntity.GetEntityName() == "button_fan2")
	{
		if (flFan2Delay <= Globals.GetCurrentTime())
		{
			if (iF2SPitch == 100 || iF2SPitch == 0)
			{
				Engine.EmitSoundEntity(pEntity, "Buttons.snd14");
				flFan2Delay = Globals.GetCurrentTime() + 45.0f;

				if (bFan2IsOn)
				{
					bFan2IsOn = false;
					iF2SPitch = 100;
					Fan2SNDStop();
					Engine.Ent_Fire("func_fan2", "stop");
					Engine.Ent_Fire("fanpush2", "disable", "0", "0.75");
				}

				else
				{
					bFan2IsOn = true;
					iF2SPitch = 0;
					Fan2SNDPlay();
					Engine.Ent_Fire("func_fan2", "start");
					Engine.Ent_Fire("fanpush2", "enable", "0", "1.25");
					Schedule::Task(10.0f, "TurnOffFan2");
				}
			}
		}
	}
}

void Fan1SNDPlay()
{
	if (iF1SPitch == 0)
	{
		Engine.Ent_Fire("snd_fan1", "Volume", "10");
	}

	iF1SPitch++;

	Engine.Ent_Fire("snd_fan1", "Pitch", formatInt(iF1SPitch));

	if (iF1SPitch != 100 && iF1SPitch > 0 && iF1SPitch < 100)
	{
		Schedule::Task(0.025f, "Fan1SNDPlay");
	}
}

void Fan1SNDStop()
{
	iF1SPitch--;

	Engine.Ent_Fire("snd_fan1", "Pitch", formatInt(iF1SPitch));

	if (iF1SPitch != 0 && iF1SPitch > 0 && iF1SPitch < 100)
	{
		Schedule::Task(0.025f, "Fan1SNDStop");
	}

	if (iF1SPitch == 0)
	{
		Engine.Ent_Fire("snd_fan1", "Volume", "0");
	}
}

void Fan2SNDPlay()
{
	if (iF2SPitch == 0)
	{
		Engine.Ent_Fire("snd_fan2", "Volume", "10");
	}

	iF2SPitch++;

	Engine.Ent_Fire("snd_fan2", "Pitch", formatInt(iF2SPitch));

	if (iF2SPitch != 100 && iF2SPitch > 0 && iF2SPitch < 100)
	{
		Schedule::Task(0.025f, "Fan2SNDPlay");
	}
}

void Fan2SNDStop()
{
	iF2SPitch--;

	Engine.Ent_Fire("snd_fan2", "Pitch", formatInt(iF2SPitch));

	if (iF2SPitch > 0)
	{
		Schedule::Task(0.025f, "Fan2SNDStop");
	}

	if (iF2SPitch == 0)
	{
		Engine.Ent_Fire("snd_fan2", "Volume", "0");
	}
}

void TurnOnFan1()
{
	if (!bFan1IsOn)
	{
		bFan1IsOn = true;
		iF1SPitch = 0;
		Fan1SNDPlay();
		Engine.Ent_Fire("func_fan1", "start");
		Engine.Ent_Fire("fanpush", "enable", "0", "0.75");
	}
}

void TurnOffFan2()
{
	if (bFan2IsOn)
	{
		bFan2IsOn = false;
		iF2SPitch = 100;
		Fan2SNDStop();
		Engine.Ent_Fire("func_fan2", "stop");
		Engine.Ent_Fire("fanpush2", "disable", "0", "0.75");
	}
}