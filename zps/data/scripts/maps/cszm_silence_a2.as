#include "cszm_modules/spawncrates"
#include "cszm_modules/lobbyambient"
#include "cszm_modules/newspawn"

array<array<CSpawnPoint@>> New_Spawns = 
{
	{
		CSpawnPoint(Vector(32, -208, -255.188), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-56, 48, -250.43), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-8, 96, -250.43), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-12, 284, -250.43), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(0, -400, -255.188), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(0, 656, -254.229), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(72, 200, -253.08), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(0, -272, -255.188), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(32, 592, -254.229), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-56, 232, -253.467), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-60, 348, -250.75), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-64, -336, -255.188), QAngle(0, -0.261528, 0)),
		CSpawnPoint(Vector(-64, -208, -255.188), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(16, 160, -253.08), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(40, 48, -254.75), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(0, 784, -254.229), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(80, 96, -254.43), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-64, 848, -254.229), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(32, 344, -255.408), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(8, 224, -253.467), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(32, -464, -255.188), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(32, -336, -255.188), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(32, 848, -254.229), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-64, -464, -255.188), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-56, 156, -253.467), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-64, 720, -254.229), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(-64, 592, -254.229), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(80, 284, -254.75), QAngle(0, 0, 0)),
		CSpawnPoint(Vector(32, 720, -254.229), QAngle(0, 0, 0))
	},
	{
		CSpawnPoint(Vector(-42.8879, 285.981, -254.969), QAngle(-4.79156, -12.5603, 0)),
		CSpawnPoint(Vector(132.226, 12.1632, -255.969), QAngle(-6.71546, 36.7351, 0)),
		CSpawnPoint(Vector(79.3522, 1045.69, -255.969), QAngle(2.72254, -93.2189, 0)),
		CSpawnPoint(Vector(647.413, 1015.6, -236.537), QAngle(20.1828, 28.3135, 0)),
		CSpawnPoint(Vector(879.178, 861.99, -223.969), QAngle(10.2366, -78.6392, 0)),
		CSpawnPoint(Vector(602.432, -80.1027, -223.969), QAngle(3.41219, 166.556, 0)),
		CSpawnPoint(Vector(1072.03, 620.386, -223.969), QAngle(2.64988, -30.7469, 0)),
		CSpawnPoint(Vector(1824.54, 554.357, -255.969), QAngle(1.63349, -120.312, 0)),
		CSpawnPoint(Vector(1149.15, -783.037, -255.98), QAngle(0.254097, 14.0472, 0)),
		CSpawnPoint(Vector(4.70648, -780.065, -255.969), QAngle(0.471898, 54.7759, 0)),
		CSpawnPoint(Vector(298.321, -194.509, -223.969), QAngle(1.70609, -48.2196, 0)),
		CSpawnPoint(Vector(1050.38, -494.013, -47.9688), QAngle(4.46487, 160.699, 0)),
		CSpawnPoint(Vector(1603.53, -483.677, -47.9688), QAngle(4.39226, 136.088, 0)),
		CSpawnPoint(Vector(573.961, 660.151, -47.9688), QAngle(7.91335, -95.3744, 0)),
		CSpawnPoint(Vector(1614.32, 699.146, -47.9688), QAngle(12.1968, 125.91, 0)),
		CSpawnPoint(Vector(736.331, 397.35, -45.9688), QAngle(2.50465, 48.1197, 0)),
		CSpawnPoint(Vector(1734.33, 35.1199, -575.969), QAngle(-5.88065, 81.6972, 0)),
		CSpawnPoint(Vector(1941.78, 1099.21, -575.969), QAngle(1.63345, -148.567, 0)),
		CSpawnPoint(Vector(742.969, 899.031, -766.969), QAngle(-27.5155, 122.486, 0)),
		CSpawnPoint(Vector(1412.07, 946.496, -766.969), QAngle(14.0117, 62.8448, 0)),
		CSpawnPoint(Vector(636.607, -168.773, -575.969), QAngle(8.78449, -131.251, 0)),
		CSpawnPoint(Vector(939.945, 634.771, -639.969), QAngle(3.37579, -22.8466, 0)),
		CSpawnPoint(Vector(1267.5, -101.941, -218.834), QAngle(13.0316, -32.746, 0)),
		CSpawnPoint(Vector(740.837, 1658.23, -574.969), QAngle(20.2916, -125.324, 0))
	},
	{
		CSpawnPoint(Vector(449.074, 283.341, -47.9688), QAngle(0, -23.158, 0)),
		CSpawnPoint(Vector(520.92, 91.7454, -47.9688), QAngle(0, 24.5082, 0)),
		CSpawnPoint(Vector(639.6, 278.578, -47.9688), QAngle(22.2519, -151.2, 0)),
		CSpawnPoint(Vector(639.995, 123.231, -47.9688), QAngle(22.869, 153.878, 0)),
		CSpawnPoint(Vector(763.898, 88.4035, -47.9688), QAngle(2.68622, 31.9102, 0)),
		CSpawnPoint(Vector(881.598, 289.975, -47.9688), QAngle(3.08552, -123.612, 0)),
		CSpawnPoint(Vector(1144.93, 69.5962, -47.9688), QAngle(17.5329, 102.441, 0)),
		CSpawnPoint(Vector(944.031, 319.969, -47.9688), QAngle(18.15, -53.4077, 0)),
		CSpawnPoint(Vector(1154.48, 306.547, -47.9688), QAngle(14.4474, -142.996, 0)),
		CSpawnPoint(Vector(1373.92, 430.613, -47.9688), QAngle(3.33962, 128.686, 0)),
		CSpawnPoint(Vector(1601.81, 833.836, -47.9688), QAngle(14.9193, -132.941, 0)),
		CSpawnPoint(Vector(1143.59, 635.323, -47.9688), QAngle(18.5857, -170.657, 0)),
		CSpawnPoint(Vector(1088.39, 976.13, -47.9688), QAngle(4.42864, -150.159, 0)),
		CSpawnPoint(Vector(850.41, 970.799, -47.9688), QAngle(2.86774, -49.56, 0)),
		CSpawnPoint(Vector(930.168, 803.843, -47.9688), QAngle(2.43206, 73.122, 0)),
		CSpawnPoint(Vector(203.959, 587.989, -47.9688), QAngle(10.164, 50.0113, 0)),
		CSpawnPoint(Vector(209.13, 811.99, -47.9688), QAngle(15.5727, -51.7013, 0)),
		CSpawnPoint(Vector(479.3, 839.74, -47.9688), QAngle(6.53395, -120.635, 0)),
		CSpawnPoint(Vector(391.667, 591.713, -47.9688), QAngle(6.53396, 95.4228, 0)),
		CSpawnPoint(Vector(592.689, 427.687, -47.9688), QAngle(9.29276, 141.464, 0)),
		CSpawnPoint(Vector(203.965, -435.192, -47.9688), QAngle(9.54684, 62.5841, 0)),
		CSpawnPoint(Vector(501.084, -171.902, -47.9688), QAngle(13.5761, -38.851, 0)),
		CSpawnPoint(Vector(771.44, -469.705, -47.9688), QAngle(7.11472, 53.8592, 0)),
		CSpawnPoint(Vector(985.939, -109.084, -47.9688), QAngle(11.9063, -114.065, 0)),
		CSpawnPoint(Vector(993.755, -322.335, -47.9688), QAngle(14.1569, 153.733, 0)),
		CSpawnPoint(Vector(1388.35, -591.382, -47.9688), QAngle(8.34891, 137.193, 0)),
		CSpawnPoint(Vector(1140.54, -610.241, -47.9688), QAngle(7.69551, 46.3345, 0)),
		CSpawnPoint(Vector(1600.91, -165.763, -47.9688), QAngle(4.24702, 127.089, 0))
	}
};

int iSurvInBasement;
bool bIsBZSEnabled;

const int TEAM_LOBBYGUYS = 0;
const int TEAM_SURVIVORS = 2;

void OnMapInit()
{
	Events::Player::OnPlayerSpawn.Hook(@OnPlayerSpawn);
	Schedule::Task(0.05f, "SetStuff");

	iMinCrates = 0;
	iMaxCrates = 7;

	g_PICOrigin.insertLast(Vector(563.168, 1158.57, -255.513));
	g_PICAngles.insertLast(QAngle(0, -124.061, 0));

	g_PICOrigin.insertLast(Vector(1085.96, 604.511, -223.5));
	g_PICAngles.insertLast(QAngle(0, -37.9823, 0));

	g_PICOrigin.insertLast(Vector(1115.62, -514.564, -208.483));
	g_PICAngles.insertLast(QAngle(-90, 111.568, 180));

	g_PICOrigin.insertLast(Vector(1442.12, -710.87, -255.5));
	g_PICAngles.insertLast(QAngle(0, 45.9262, 0));

	g_PICOrigin.insertLast(Vector(1690.78, 607.679, -255.5));
	g_PICAngles.insertLast(QAngle(0, -57.5093, 0));

	g_PICOrigin.insertLast(Vector(906.575, 634.657, -111.649));
	g_PICAngles.insertLast(QAngle(0, 163.374, -90));

	g_PICOrigin.insertLast(Vector(424.675, -23.2762, -223.5));
	g_PICAngles.insertLast(QAngle(0, 43.616, 0));

	g_PICOrigin.insertLast(Vector(183.272, -179.602, -183.483));
	g_PICAngles.insertLast(QAngle(0, 1.70893, 0));

	g_PICOrigin.insertLast(Vector(772.598, -25.9671, -47.5992));
	g_PICAngles.insertLast(QAngle(0, 29.2479, 0));

	g_PICOrigin.insertLast(Vector(1056.26, -554.552, 65.8727));
	g_PICAngles.insertLast(QAngle(0, 99.0, 90));

	g_PICOrigin.insertLast(Vector(1599.29, 693.566, -47.5002));
	g_PICAngles.insertLast(QAngle(0, -90.216, 0));

	g_PICOrigin.insertLast(Vector(296.685, 869.228, -47.5395));
	g_PICAngles.insertLast(QAngle(0, 59.6748, 0));

	g_PICOrigin.insertLast(Vector(202.921, 257.598, -56.0867));
	g_PICAngles.insertLast(QAngle(12.8485, 37.5217, -16.111));

	g_PICOrigin.insertLast(Vector(1536.22, 475.612, -639.5));
	g_PICAngles.insertLast(QAngle(0, -40.5027, 0));

	g_PICOrigin.insertLast(Vector(744.534, -421.528, -575.5));
	g_PICAngles.insertLast(QAngle(0, 28.4555, 0));

	g_PICOrigin.insertLast(Vector(171.652, 1217.12, -727.493));
	g_PICAngles.insertLast(QAngle(0, 49.7227, 0));

	g_PICOrigin.insertLast(Vector(1417.45, 927.386, -766.622));
	g_PICAngles.insertLast(QAngle(0, -121.457, 0));

	g_PICOrigin.insertLast(Vector(2268.33, 549.154, -495.249));
	g_PICAngles.insertLast(QAngle(0, 136.575, 0));

	g_PICOrigin.insertLast(Vector(874.264, 582.238, -45.5426));
	g_PICAngles.insertLast(QAngle(0, 44.9195, 0));

	g_PICOrigin.insertLast(Vector(212.612, -481.648, -47.5002));
	g_PICAngles.insertLast(QAngle(-2.50223e-006, -125.909, 0));
}

void OnNewRound()
{
	Schedule::Task(0.05f, "SetStuff");
}

void OnMatchStarting()
{
	bIsBZSEnabled = false;
}

void OnMatchBegin()
{
	Schedule::Task(0.5f, "SpawnCrates");
}

void SetStuff()
{
	Engine.Ent_Fire("Precache", "kill");
	Engine.Ent_Fire("shading", "StartOverlays");
	PlayLobbyAmbient();

	RemoveNativeSpawns("info_player_zombie");
	RemoveNativeSpawns("info_player_human");
	CreateSpawnsFromArray(New_Spawns);
}

HookReturnCode OnPlayerSpawn(CZP_Player@ pPlayer)
{
	CBasePlayer@ pPlrEnt = pPlayer.opCast();
	CBaseEntity@ pBaseEnt = pPlrEnt.opCast();

	if (pBaseEnt.GetTeamNumber() != TEAM_LOBBYGUYS)
	{
		Engine.Ent_Fire_Ent(pBaseEnt, "SetFogController", "base_fog");
	}

	else
	{
		Engine.Ent_Fire_Ent(pBaseEnt, "SetFogController", "lobby_fog");
		PlayLobbyAmbient();
	}

	return HOOK_CONTINUE;	
}